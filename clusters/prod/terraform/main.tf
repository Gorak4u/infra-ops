# Auto-generated by OmniCloud Ops at 2025-12-09T16:51:12.161Z
# Cluster: prod
# Region: us-east-1

provider "aws" {
  region = "us-east-1"
  default_tags {
    tags = {
      ManagedBy   = "OmniCloud"
      Environment = "Production"
      Cluster     = "prod"
      Project     = "DataPlatform"
    }
  }
}

# --- IAM Role for Node (SSM + CloudWatch + Backups) ---
resource "aws_iam_role" "cassandra_role" {
  name = "prod-node-role"
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Action = "sts:AssumeRole"
      Effect = "Allow"
      Principal = { Service = "ec2.amazonaws.com" }
    }]
  })
}

# Attach SSM Core for Shell Access without SSH keys
resource "aws_iam_role_policy_attachment" "ssm_policy" {
  role       = aws_iam_role.cassandra_role.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
}

# Custom Policy for S3 Backups
resource "aws_iam_role_policy" "backup_policy" {
  name = "prod-backup-policy"
  role = aws_iam_role.cassandra_role.id
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = ["s3:PutObject", "s3:GetObject", "s3:ListBucket"]
        Resource = ["arn:aws:s3:::omnicloud-backups", "arn:aws:s3:::omnicloud-backups/*"]
      }
    ]
  })
}

resource "aws_iam_instance_profile" "cassandra_profile" {
  name = "prod-profile"
  role = aws_iam_role.cassandra_role.name
}

# --- Security Group ---
resource "aws_security_group" "cassandra_sg" {
  name        = "prod-sg"
  description = "Security group for Cassandra Cluster prod"
  vpc_id      = "vpc-0a1b2c3d"

  # Inter-node Communication (Gossip/SSL/JMX)
  ingress {
    description = "Inter-node Cluster Communication"
    from_port = 7000
    to_port   = 7001
    protocol  = "tcp"
    self      = true
  }

  # Client Access (CQL)
  ingress {
    description = "CQL Client Access"
    from_port   = 9042
    to_port     = 9042
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  # JMX Monitoring
  ingress {
    description = "JMX Monitoring"
    from_port   = 7199
    to_port     = 7199
    protocol    = "tcp"
    cidr_blocks = ["10.0.0.0/8"] # Internal VPC only
  }

  # Prometheus Exporter
  ingress {
    description = "Prometheus Node Exporter"
    from_port   = 9100
    to_port     = 9100
    protocol    = "tcp"
    self        = true
  }

  # Egress - Allow all
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

# --- Compute Nodes ---
# Using standard aws_instance resource for maximum control
resource "aws_instance" "node" {
  count = 3
  
  ami           = "ami-0c7217cdde317cfec" # Example: Canonical Ubuntu 22.04 LTS
  instance_type = "r5.2xlarge"
  key_name      = "omnicloud-prod-key" # Assumed pre-existing or managed globally
  
  subnet_id              = element(["subnet-1a","subnet-1b","subnet-1c"], count.index % 3)
  vpc_security_group_ids = [aws_security_group.cassandra_sg.id]
  iam_instance_profile   = aws_iam_instance_profile.cassandra_profile.name
  
  # Root Volume (OS)
  root_block_device {
    volume_size = 50
    volume_type = "gp3"
    encrypted   = true
    kms_key_id  = ""
    tags = {
      Name = "prod-node-${count.index + 1}-root"
    }
  }

  # EBS Optimization
  ebs_optimized = true

  # IMDSv2 Requirement (Security)
  metadata_options {
    http_endpoint               = "enabled"
    http_tokens                 = "required"
    http_put_response_hop_limit = 1
  }

  # Bootstrap Script
  user_data = file("${path.module}/../../bootstrap.sh")
  user_data_replace_on_change = true

  tags = {
    Name = "prod-node-${count.index + 1}"
    Rack = "rack-${(count.index % 3) + 1}"
  }
  
  lifecycle {
    ignore_changes = [ami, user_data]
  }
}

# --- Data Volumes (Attached EBS) ---
# Explicit attachment allows for volume persistence separate from instance lifecycle
resource "aws_ebs_volume" "data" {
  count             = 3
  availability_zone = aws_instance.node[count.index].availability_zone
  size              = 1000
  type              = "gp3"
  encrypted         = true
  # iops            = 3000 # Only if gp3/io1
  # throughput      = 125  # Only if gp3
  
  tags = {
    Name = "prod-data-${count.index + 1}"
  }
}

resource "aws_volume_attachment" "data_att" {
  count       = 3
  device_name = "/dev/sdf"
  volume_id   = aws_ebs_volume.data[count.index].id
  instance_id = aws_instance.node[count.index].id
  
  # Force detach on destroy to avoid hanging
  force_detach = true
}

output "node_private_ips" {
  value = aws_instance.node[*].private_ip
}

output "node_ids" {
  value = aws_instance.node[*].id
}
